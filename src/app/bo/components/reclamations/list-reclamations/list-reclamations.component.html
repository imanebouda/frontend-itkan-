<p-fieldset legend="Recherchez les Réclamations" [toggleable]="true">
  <form [formGroup]="searchForm" (ngSubmit)="searchReclamations()">
    <div class="d-flex justify-content-center mb-3">
      <div class="field col-4 text-center">
        <label class="mb-2">Status</label>
        <p-dropdown [options]="statusList" formControlName="status" [filter]="false" [showClear]="false" placeholder="Sélectionnez un statut">
          <ng-template let-element pTemplate="item">
            <div class="flex justify-content-between">
              <span class="font-12">{{ element?.label }}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>
      <div class="field col-4 text-center">
        <label class="mb-2">Date de Réclamation</label>
        <p-calendar formControlName="date" [yearNavigator]="true" yearRange="2000:2030" placeholder="Sélectionnez une date" dateFormat="dd/mm/yy"></p-calendar>
      </div>
    </div>
    <div class="flex justify-content-end center_media mt-2" style="column-gap: 10px;">
      <button type="submit" pButton pRipple class="p-button" icon="pi pi-search" iconPos="left" label="Rechercher / Rafraîchir" [disabled]="is_loading" style="font-size: 11px !important;"></button>
      <button pButton pRipple class="ml-2 p-button-rounded" icon="pi pi-filter-slash" tooltipPosition="left" pTooltip="Cliquez ici pour vider le formulaire" (click)="clearSearch()"></button>
      <button pButton pRipple class="ml-2 p-button-rounded p-button-success" icon="pi pi-plus" tooltipPosition="left" pTooltip="Ajouter une réclamation" (click)="showAddModal()"></button>
     
    
    </div>
  </form>
</p-fieldset>

<br>
<hr>

<app-loader *ngIf="is_loading"></app-loader>

<p-card class="m-1 mt-1 mb-1">
  <p-table responsiveLayout="scroll" [value]="reclamations" styleClass="p-datatable-responsive-demo" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 15, 20]" [totalRecords]="reclamations.length" [lazy]="true" [sortOrder]="1" sortField="id">
    <ng-template pTemplate="header">
      <tr>
        
        <th style="min-width: 10rem;">Objet</th>
        <th style="min-width: 12rem;">Reclamant</th>
        <th style="min-width: 10rem;">Statut</th>
        <th style="min-width: 10rem;">Date de Réclamation</th>
        <th style="min-width: 10rem;">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-reclamation>
      <tr>
        <td>{{ reclamation.objet}}</td>
        <td>{{ reclamation.reclamant?.nom }} {{ reclamation.reclamant?.prenom }}</td>
        <td>{{ reclamation.status }}</td>
        <td>{{ reclamation.creationDate | date: 'dd/MM/yyyy' }}</td>
        <td>
          <i pButton pRipple class="p-button-rounded p-button-warning" icon="pi pi-info" tooltipPosition="right" [routerLink]="['/reclamation-details', reclamation.id]"></i>

          <button pButton pRipple class="p-button-rounded p-button-info" icon="pi pi-pencil" tooltipPosition="left" (click)="openEditModal(reclamation)"></button>
          <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-danger" tooltipPosition="right" (click)="deleteReclamation(reclamation)"></button>
          <button pButton type="button" icon="pi pi-search" class="circular-button" (click)="openAnalyseModal(reclamation)"></button>
         <!-- <button pButton type="button" icon="pi pi-users" class="circular-button" (click)="openDefineComiteModal(reclamation)"></button>-->
        </td>
      </tr>
    </ng-template>
  </p-table>
</p-card>

<p-dialog header="Détails de la Réclamation" [(visible)]="displayDetailsModal" [modal]="true" [responsive]="true" [style]="{width: '50vw'}">
  <div *ngIf="selectedReclamation" class="details-dialog-content">
    <div class="field">
      <label class="field-label" for="id">ID:</label>
      <span class="field-value">{{ selectedReclamation.id }}</span>
    </div>
    <div class="field">
      <label class="field-label" for="objet">Objet:</label>
      <span class="field-value">{{ selectedReclamation.objet }}</span>
    </div>
    <div class="field">
      <label class="field-label" for="analyse">Analyse:</label>
      <span class="field-value">{{ selectedReclamation.analyse }}</span>
    </div>
    <div class="field">
      <label class="field-label" for="status">Status:</label>
      <span class="field-value">{{ selectedReclamation.status }}</span>
    </div>
    <div class="field">
      <label class="field-label" for="reclamantID">ID du Réclamant:</label>
      <span class="field-value">{{ selectedReclamation.reclamantID }}</span>
    </div>
    <div class="field">
      <label class="field-label" for="responsableID">ID du Responsable:</label>
      <span class="field-value">{{ selectedReclamation.responsableID }}</span>
    </div>
    <div class="field">
      <label class="field-label" for="creationDate">Date de Réclamation:</label>
      <span class="field-value">{{ selectedReclamation.creationDate | date: 'dd/MM/yyyy' }}</span>
    </div>
  </div>
  <p-footer>
    <button type="button" pButton icon="pi pi-times" label="Fermer" (click)="displayDetailsModal = false"></button>
  </p-footer>
</p-dialog>


<p-dialog header="Modifier une Réclamation" [(visible)]="displayEditModal" [modal]="true" [style]="{ width: '50vw' }" (onHide)="onHideEdit()">
  <div class="p-fluid">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" [class.active]="currentEditTab === 'reclamant'" (click)="switchEditTab('reclamant')">Réclamant</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="currentEditTab === 'reclamation'" (click)="switchEditTab('reclamation')">Réclamation</a>
      </li>
    </ul>

    <div *ngIf="currentEditTab === 'reclamant'">
      <form [formGroup]="editReclamantForm" (ngSubmit)="saveEditedReclamant()">
        <div class="p-field">
          <label for="nom">Nom</label>
          <input id="nom" type="text" formControlName="nom" pInputText />
        </div>
        <div class="p-field">
          <label for="prenom">Prénom</label>
          <input id="prénom" type="text" formControlName="prénom" pInputText />
        </div>
        <div class="p-field">
          <label for="email">Email</label>
          <input id="email" type="email" formControlName="email" pInputText />
        </div>
        <div class="p-field">
          <label for="mobile">Mobile</label>
          <input id="mobile" type="text" formControlName="mobile" pInputText />
        </div>
        <div class="p-field">
          <label for="adresse">Adresse</label>
          <input id="adresse" type="text" formControlName="adresse" pInputText />
        </div>
        <div class="p-field ville-field">
          <label for="ville">Ville</label>
          <input id="ville" type="text" formControlName="ville" pInputText />
        </div>
        <div class="p-field">
          <label for="creationDate">Date de Création</label>
          <p-calendar id="creationDate" formControlName="creationDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
        </div>
        <div class="button-container">
          <button type="submit" pButton label="Suivant" class="p-button-primary button-enregistrer"></button>
        </div>
      </form>
    </div>

    <div *ngIf="currentEditTab === 'reclamation'">
      <form [formGroup]="editReclamationForm" (ngSubmit)="saveEditedReclamation()">
        <div class="p-field">
          <label for="objet">Objet</label>
          <input id="objet" type="text" formControlName="objet" pInputText />
        </div>
        <div class="p-field">
          <label for="détail">Détail</label>
          <textarea id="détail" formControlName="détail" pInputTextarea></textarea>
        </div>
        <!--<div class="p-field">
          <label for="analyse">Analyse</label>
          <textarea id="analyse" formControlName="analyse" pInputTextarea></textarea>
        </div>-->
        <div class="p-field">
          <label for="status">Status</label>
          <p-dropdown id="status" formControlName="status" [options]="statusList" placeholder="Sélectionnez un statut"></p-dropdown>
        </div>
        <div class="p-field">
          <label for="reclamantID">Réclamant ID</label>
          <input id="reclamantID" type="text" formControlName="reclamantID" [value]="createdReclamantId" pInputText readonly />
        </div>
        <div class="p-field">
          <label for="responsableID">Responsable</label>
          <p-dropdown 
            id="responsableID" 
            formControlName="responsableID" 
            [options]="users" 
            optionLabel="nomCompletUtilisateur" 
            optionValue="id" 
            placeholder="Sélectionnez un responsable">
          </p-dropdown>
        </div>
        
        <div class="p-field date-creation">
          <label for="creationDate">Date de Réclamation</label>
          <p-calendar id="creationDate" formControlName="creationDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
        </div>
        <div class="p-button-group">
          <button type="button" pButton label="Précédent" class="p-button-secondary" (click)="switchEditTab('reclamant')"></button>
          <button type="submit" pButton label="Enregistrer" class="p-button-primary" [disabled]="!editReclamationForm.valid || !isReclamantCreated"></button>
        </div>
      </form>
    </div>
  </div>
</p-dialog>

<p-dialog header="Ajouter une Réclamation" [(visible)]="displayAddModal" [modal]="true" [style]="{ width: '50vw' }" (onHide)="onHide()">
  <div class="p-fluid">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link" [class.active]="currentTab === 'reclamant'" (click)="switchTab('reclamant')">Réclamant</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" [class.active]="currentTab === 'reclamation'" (click)="switchTab('reclamation')">Réclamation</a>
      </li>
    </ul>

    <div *ngIf="currentTab === 'reclamant'">
      <form [formGroup]="reclamantForm" (ngSubmit)="saveReclamant()">
        <div class="p-field">
          <label for="nom">Nom</label>
          <input id="nom" type="text" formControlName="nom" pInputText />
        </div>
        <div class="p-field">
          <label for="prenom">Prénom</label>
          <input id="prénom" type="text" formControlName="prénom" pInputText />
        </div>
        <div class="p-field">
          <label for="email">Email</label>
          <input id="email" type="email" formControlName="email" pInputText />
        </div>
        <div class="p-field">
          <label for="mobile">Mobile</label>
          <input id="mobile" type="text" formControlName="mobile" pInputText />
        </div>
        <div class="p-field">
          <label for="adresse">Adresse</label>
          <input id="adresse" type="text" formControlName="adresse" pInputText />
        </div>
        <div class="p-field ville-field">
          <label for="ville">Ville</label>
          <input id="ville" type="text" formControlName="ville" pInputText />
        </div>
        <div class="p-field">
          <label for="creationDate">Date de Création</label>
          <p-calendar id="creationDate" formControlName="creationDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
        </div>
        <div class="button-container">
          <button type="submit" pButton label="Suivant" class="p-button-primary button-enregistrer"></button>
        </div>
      </form>
    </div>

    <div *ngIf="currentTab === 'reclamation'">
      <form [formGroup]="reclamationForm" (ngSubmit)="saveNewReclamation()">
        <div class="p-field">
          <label for="objet">Objet</label>
          <input id="objet" type="text" formControlName="objet" pInputText />
        </div>
        <div class="p-field">
          <label for="détail">Détail</label>
          <textarea id="détail" formControlName="détail" pInputTextarea></textarea>
        </div>
       <!--- <div class="p-field">
          <label for="analyse">Analyse</label>
          <textarea id="analyse" formControlName="analyse" pInputTextarea></textarea>
        </div>-->
        <div class="p-field">
          <label for="status">Status</label>
          <p-dropdown id="status" formControlName="status" [options]="statusList" placeholder="Sélectionnez un statut"></p-dropdown>
        </div>
        <div class="p-field">
          <label for="reclamantID">Réclamant ID</label>
          <input id="reclamantID" type="text" formControlName="reclamantID" [value]="createdReclamantId" pInputText readonly />
        </div>
        <div class="p-field">
          <label for="responsableID">Responsable</label>
          <p-dropdown 
            id="responsableID" 
            formControlName="responsableID" 
            [options]="users" 
            optionLabel="nomCompletUtilisateur" 
            optionValue="id" 
            placeholder="Sélectionnez un responsable">
          </p-dropdown>
        </div>
        
        <div class="p-field date-creation">
          <label for="creationDate">Date de Réclamation</label>
          <p-calendar id="creationDate" formControlName="creationDate" [showIcon]="true" dateFormat="dd/mm/yy"></p-calendar>
        </div>
        <div class="p-button-group">
          <button type="button" pButton label="Précédent" class="p-button-secondary" (click)="switchTab('reclamant')"></button>
          <button type="submit" pButton label="Enregistrer" class="p-button-primary" [disabled]="!reclamationForm.valid || !isReclamantCreated"></button>
        </div>
      </form>
    </div>
  </div>
</p-dialog>


<p-dialog [(visible)]="displayAnalyseModal" modal="modal" [responsive]="true" showEffect="fade" [style]="{ width: '50vw' }">
  <p-header>
    Analyse Reclamation
  </p-header>
  <form [formGroup]="analyseForm" (ngSubmit)="saveAnalyse()">
    <div class="p-fluid">
      <div class="p-field">
        <label for="analyse"></label>
        <textarea id="analyse" rows="3" pInputTextarea formControlName="analyse"></textarea>
      </div>
      <p-footer>
        <button pButton type="submit" label="Save" icon="pi pi-check"></button>
      </p-footer>
    </div>
  </form>
</p-dialog>

<div *ngIf="showDefineComiteModal" class="modal">
  <div class="modal-content">
    <h2>Définir Comité Réclamation</h2>
    <table>
      <thead>
        <tr>
          <th>Sélectionner</th>
          <th>ID</th>
          <th>Nom d'utilisateur</th>
          <th>Nom complet</th>
          <th>Email</th>
          <th>IdRôle</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td><input type="checkbox" (change)="onUserSelect(user)" /></td>
          <td>{{ user.id }}</td>
          <td>{{ user.username }}</td>
          <td>{{ user.nomCompletUtilisateur }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user?.idRole }}</td>
        </tr>
      </tbody>
    </table>
    <div class="ui-dialog-footer text-right">
    <button type="button" pButton label="Fermer" (click)="closeDefineComiteModal()" class="p-button p-button-secondary p-button-sm"></button>
      <button type="submit" pButton label="Enregistrer" (click)="submitSelectedUsers()" class="p-button p-button-primary p-button-sm ml-2"></button>
  </div>
    </div>
</div>

